<div class="min-h-screen w-full font-[Inter] flex justify-center py-10 px-4 bg-[#f9fafb] text-[#111827]">
  <form
    [formGroup]="form"
    class="w-full max-w-3xl bg-white rounded-2xl shadow-xl p-8 space-y-10 border border-[#e5e7eb]"
  >
    <!-- üßæ HEADER -->
    <header class="border-b border-[#e5e7eb] pb-4">
      <h1 class="text-2xl font-bold text-[#008060]">Checkout</h1>
      <p class="text-sm text-gray-600 mt-1">
        Complet√° tus datos y eleg√≠ c√≥mo quer√©s recibir y pagar tu pedido.
      </p>
    </header>

    <!-- üí≥ M√âTODO DE PAGO -->
    <div class="flex gap-4 overflow-x-auto pb-2 hide-scrollbar">
      <!-- Efectivo -->
      <label
        for="cash"
        class="relative flex-shrink-0 w-60 rounded-xl cursor-pointer transition-all duration-300 overflow-hidden border-2 hover:scale-[1.02]"
        [ngClass]="{
          'border-[#008060] ring-2 ring-[#008060]/40 shadow-lg':
            form.get('paymentMethod')?.value === 'Efectivo',
          'border-[#e5e7eb] shadow-sm':
            form.get('paymentMethod')?.value !== 'Efectivo'
        }"
      >
        <div
          class="flex flex-col items-center justify-center p-3 text-center bg-gradient-to-br from-[#10b981] to-[#059669] text-white h-[100px]"
        >
          <div class="flex flex-col items-center gap-1 leading-tight">
            <i class="pi pi-money-bill text-xl"></i>
            <span class="font-semibold text-sm mt-0.5">Efectivo</span>
            <p class="text-[11px] opacity-90">
              Pag√°s al recibir o retirar tu pedido
            </p>
          </div>
          <p-radioButton
            name="paymentMethod"
            value="Efectivo"
            formControlName="paymentMethod"
            inputId="cash"
            class="absolute top-2 right-2"
          ></p-radioButton>
        </div>
      </label>

      <!-- Transferencia -->
      <label
        for="bank"
        class="relative flex-shrink-0 w-60 rounded-xl cursor-pointer transition-all duration-300 overflow-hidden border-2 hover:scale-[1.02]"
        [ngClass]="{
          'border-[#008060] ring-2 ring-[#008060]/40 shadow-lg':
            form.get('paymentMethod')?.value === 'Transferencia Bancaria',
          'border-[#e5e7eb] shadow-sm':
            form.get('paymentMethod')?.value !== 'Transferencia Bancaria'
        }"
      >
        <div
          class="flex flex-col items-center justify-center p-3 text-center bg-gradient-to-br from-[#38bdf8] to-[#0ea5e9] text-white h-[100px]"
        >
          <div class="flex flex-col items-center gap-1 leading-tight">
            <i class="pi pi-wallet text-xl"></i>
            <span class="font-semibold text-sm mt-0.5">Transferencia</span>
            <p class="text-[11px] opacity-90">
              Transfer√≠ el monto directamente a nuestra cuenta
            </p>
          </div>
          <p-radioButton
            name="paymentMethod"
            value="Transferencia Bancaria"
            formControlName="paymentMethod"
            inputId="bank"
            class="absolute top-2 right-2"
          ></p-radioButton>
        </div>
      </label>
    </div>

    <!-- üë§ DATOS DEL CLIENTE -->
    <section class="grid sm:grid-cols-2 gap-4">
      <div>
        <label class="text-sm font-medium mb-1 block">Nombre</label>
        <input
          pInputText
          formControlName="customerName"
          placeholder="Juan P√©rez"
          class="w-full rounded-lg border border-[#e5e7eb] px-3 py-2 focus:ring-2 focus:ring-[#008060]"
        />
      </div>

      <div>
        <label class="text-sm font-medium mb-1 block">Correo electr√≥nico</label>
        <input
          pInputText
          formControlName="customerEmail"
          placeholder="tu@email.com"
          class="w-full rounded-lg border border-[#e5e7eb] px-3 py-2 focus:ring-2 focus:ring-[#008060]"
        />
      </div>
    </section>

    <!-- üì± WHATSAPP -->
    <section>
      <label class="text-sm font-medium mb-1 block">WhatsApp</label>
      <input
        pInputText
        formControlName="customerWhatsapp"
        type="tel"
        placeholder="+54 9 11 ..."
        class="w-full rounded-lg border border-[#e5e7eb] px-3 py-2 focus:ring-2 focus:ring-[#008060]"
      />
      <p class="text-xs text-gray-500 mt-1">
        Us√° formato internacional. Ej: +5491123456789
      </p>
    </section>

    <!-- üöö ENTREGA -->
    <section>
      <h2 class="font-semibold text-lg mb-3 text-[#008060]">Entrega</h2>
      <div class="flex flex-col gap-2">
        <label class="flex items-center gap-2 cursor-pointer">
          <p-radioButton
            name="deliveryMethod"
            value="delivery"
            formControlName="deliveryMethod"
            inputId="delivery"
          />
          <span>Env√≠o a domicilio ({{ envio | currency : "ARS" }})</span>
        </label>

        <label class="flex items-center gap-2 cursor-pointer">
          <p-radioButton
            name="deliveryMethod"
            value="pickup"
            formControlName="deliveryMethod"
            inputId="pickup"
          />
          <span>Retiro en tienda (gratis)</span>
        </label>
      </div>
    </section>
    <!-- üìç DIRECCI√ìN -->
<!-- üìç DIRECCI√ìN Y ENV√çO -->
<section *ngIf="form.value.deliveryMethod === 'delivery'" class="space-y-4">
  <label class="text-sm font-medium block">Direcci√≥n</label>

  <!-- Campos de direcci√≥n -->
  <input
    pInputText
    formControlName="address"
    placeholder="Calle y n√∫mero"
    class="w-full rounded-lg border border-[#e5e7eb] px-3 py-2 focus:ring-2 focus:ring-[#008060]"
  />
  <div class="grid grid-cols-2 gap-2">
    <input
      pInputText
      formControlName="city"
      placeholder="Ciudad"
      class="rounded-lg border border-[#e5e7eb] px-3 py-2 focus:ring-2 focus:ring-[#008060]"
    />
    <input
      pInputText
      formControlName="province"
      placeholder="Provincia"
      class="rounded-lg border border-[#e5e7eb] px-3 py-2 focus:ring-2 focus:ring-[#008060]"
    />
  </div>
  <input
    pInputText
    formControlName="postalCode"
    placeholder="C√≥digo Postal"
    class="w-full rounded-lg border border-[#e5e7eb] px-3 py-2 focus:ring-2 focus:ring-[#008060]"
  />

  <!-- BOT√ìN CALCULAR -->
  <div class="mt-3 flex items-center gap-3">
    <button
      type="button"
      pButton
      class="px-4 py-2 rounded-lg bg-[#008060] text-white hover:bg-[#00684a] transition-all duration-150"
      (click)="calculateShippingFromAddress()"
      [disabled]="loading"
    >
      Calcular env√≠o
    </button>

    <div *ngIf="loading" class="text-sm text-gray-500">Calculando...</div>
  </div>

  <!-- üí∏ Resultado del c√°lculo de env√≠o -->
  <div *ngIf="shippingResult" class="mt-4 bg-[#f3f4f6] rounded-xl p-4 border border-[#e5e7eb]">
    <h4 class="text-base font-semibold text-[#008060] mb-1">Costo de env√≠o calculado</h4>
    <p class="text-sm text-gray-700">
      <b>Distancia:</b> {{ shippingResult.distanceKm | number:'1.2-2' }} km
    </p>
    <p class="text-sm text-gray-700">
      <b>Precio por km:</b> ${{ shippingResult.pricePerKm }}
    </p>
    <p class="text-sm text-gray-900 font-semibold">
      <b>Total:</b> {{ shippingResult.totalCost | currency:'ARS' }}
    </p>
  </div>

  <!-- Mensaje de ayuda si a√∫n no se calcul√≥ -->
  <div *ngIf="!shippingResult" class="text-gray-500 text-sm mt-2">
    üîç Ingres√° tu direcci√≥n y hac√© clic en <b>‚ÄúCalcular env√≠o‚Äù</b> para estimar el costo.
  </div>

  <!-- üó∫Ô∏è MAPA LEAFLET -->
  <section class="max-w-6xl mx-auto mt-6 px-5 sm:px-10">
    <h3 class="text-xl font-semibold text-gray-900 mb-3">Ubicaci√≥n de la tienda y tu direcci√≥n</h3>
    <div id="storeMap" class="w-full h-80 rounded-2xl overflow-hidden shadow-md border"></div>
    <p class="text-sm text-gray-500 mt-2">
      Pod√©s arrastrar el marcador azul para ajustar tu ubicaci√≥n exacta.
      El formulario se actualizar√° autom√°ticamente y recalcular√° el env√≠o.
    </p>
  </section>
</section>


    <!-- üóìÔ∏è PROGRAMAR RETIRO -->
    <section *ngIf="form.value.deliveryMethod === 'pickup'">
      <h2 class="font-semibold text-lg mb-2 text-[#008060]">
        Programar retiro (opcional)
      </h2>
      <div class="grid grid-cols-2 gap-3">
        <input
          pInputText
          formControlName="scheduleDate"
          type="date"
          class="rounded-lg border border-[#e5e7eb] px-3 py-2 focus:ring-2 focus:ring-[#008060]"
        />
        <input
          pInputText
          formControlName="scheduleTime"
          type="time"
          class="rounded-lg border border-[#e5e7eb] px-3 py-2 focus:ring-2 focus:ring-[#008060]"
        />
      </div>
    </section>

    <!-- üóíÔ∏è COMENTARIOS -->
    <section>
      <label class="text-sm font-medium mb-1 block">Comentario</label>
      <textarea
        pInputTextarea
        formControlName="notes"
        rows="2"
        placeholder="Aclaraciones para tu pedido..."
        class="w-full rounded-lg border border-[#e5e7eb] px-3 py-2 focus:ring-2 focus:ring-[#008060]"
      ></textarea>
    </section>

    <!-- üõí ART√çCULOS -->
    <section>
      <h2 class="font-semibold text-lg mb-2 text-[#008060]">Tu carrito</h2>
      <div
        *ngFor="let item of items"
        class="flex items-center justify-between rounded-xl border border-[#e5e7eb] p-4 mb-3 bg-[#f9fafb]"
      >
        <img
          [src]="item.product?.imagen_url?.[0] || 'https://placehold.co/80x80'"
          class="w-16 h-16 rounded-lg object-cover"
        />
        <div class="flex-1 px-3">
          <p class="text-sm font-medium">{{ item.product?.nombre_producto }}</p>
          <p class="text-xs text-gray-500">
            {{ item.precio_unit | currency : "ARS" }}
          </p>
        </div>
        <span class="font-semibold text-sm">{{ item.cantidad }}x</span>
      </div>
    </section>

    <!-- üí∞ RESUMEN -->
    <section class="border-t pt-4 text-sm space-y-1">
      <div class="flex justify-between">
        <span>Subtotal</span>
        <span>{{ subtotal | currency : "ARS" }}</span>
      </div>
      <div class="flex justify-between">
        <span>Env√≠o</span>
        <span>{{ envio | currency : "ARS" }}</span>
      </div>
      <div class="flex justify-between font-semibold text-lg">
        <span>Total</span>
        <span>{{ total | currency : "ARS" }}</span>
      </div>
    </section>

    <!-- ‚úÖ BOT√ìN FINAL -->
    <button
      pButton
      type="button"
      [label]="
        loading
          ? 'Procesando...'
          : form.value.paymentMethod === 'Mercado Pago'
          ? 'Pagar con Mercado Pago'
          : 'Finalizar pedido'
      "
      class="w-full py-3 rounded-full font-semibold text-white shadow-md hover:shadow-lg transition-all duration-300 bg-[#008060] hover:bg-[#006e52]"
      [disabled]="loading"
      (click)="placeOrder()"
    ></button>
  </form>
</div>
