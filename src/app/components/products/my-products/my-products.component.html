<div class="mt-6">
  <!-- Encabezado -->
  <div class="px-4 sm:px-12 mb-4">
    <div
      class="inline-flex items-center gap-2 rounded-full border border-pink-200 bg-pink-50 px-3 py-1 text-xs text-pink-700"
    >
      <span class="h-2 w-2 rounded-full bg-pink-500"></span>
      Inventario
    </div>
    <h1 class="mt-2 text-3xl font-semibold tracking-tight text-pink-500">
      Mis productos
    </h1>
    <p class="text-sm text-slate-500 mt-1">
      Visualiza y edita los datos de tus productos.
    </p>
  </div>

  <!-- Barra de acciones -->
  <div class="px-4 sm:px-12 mb-4">
    <div
      class="flex flex-col sm:flex-row items-stretch sm:items-center gap-3 sm:gap-4"
    >
      <!-- Buscador pill -->
      <div class="flex items-center">
        <i class="pi pi-search text-slate-400 mr-2"></i>
        <input
          type="text"
          pInputText
          [formControl]="searchCtrl"
          placeholder="Buscar producto"
          class="flex-1 bg-transparent text-slate-700 placeholder:text-slate-400"
        />
      </div>

      <div class="flex-1"></div>

      <button
        pButton
        label="Agregar producto"
        icon="pi pi-plus"
        class="rounded-full bg-emerald-500 hover:bg-emerald-600 text-white px-5 py-2.5 shadow-sm flex items-center gap-2"
        (click)="openCreateDialog()"
      ></button>
    </div>
  </div>

  <!-- Contenido -->
  <div class="px-4 sm:px-12">
    <!-- Skeleton -->
    <ng-container *ngIf="isLoading; else contentTpl">
      <div
        class="bg-white border border-slate-200 rounded-2xl shadow-sm p-6 animate-pulse"
      >
        <div class="h-5 w-1/3 bg-slate-200 rounded mb-4"></div>
        <div class="h-16 bg-slate-200 rounded mb-2"></div>
        <div class="h-16 bg-slate-200 rounded mb-2"></div>
        <div class="h-16 bg-slate-200 rounded"></div>
      </div>
    </ng-container>

    <!-- Lista / Empty -->
    <ng-template #contentTpl>
      <ng-container *ngIf="productos?.length; else emptyTpl">
        <p-accordion [multiple]="true" class="modern-accordion">
          <p-accordionTab
            *ngFor="let product of productos; trackBy: trackByProduct"
          >
            <ng-template pTemplate="header">
              <div class="flex items-center w-full">
                <div
                  class="w-12 h-12 rounded-xl overflow-hidden ring-1 ring-slate-200 bg-white mr-3"
                >
                  <img
                    class="w-full h-full object-cover"
                    [src]="product.imagen_url[0]"
                    alt="{{ product.nombre_producto }}"
                  />
                </div>
                <div class="min-w-0 flex-1">
                  <div class="font-medium text-slate-800 truncate">
                    {{ product.nombre_producto }}
                  </div>
                  <div class="text-xs text-slate-500 truncate">
                    {{ product.category?.name || "Sin categoría" }}
                  </div>
                </div>
                <div class="flex items-center gap-2 ml-auto">
                  <span class="chip chip-soft">
                    <span class="chip-dot bg-emerald-500"></span>
                    Stock: {{ getTotalStock(product) }}
                  </span>

                  <span class="chip chip-soft">
                    <span class="chip-dot bg-indigo-500"></span>
                    {{
                      product.presentacion_multiple && product.variants?.length
                        ? "Desde " +
                          (getMinPrice(product)
                            | currency : "ARS" : "symbol-narrow" : "1.0-0")
                        : (product.precio
                          | currency : "ARS" : "symbol-narrow" : "1.0-0")
                    }}
                  </span>

                  <span
                    *ngIf="
                      product.presentacion_multiple && product.variants?.length
                    "
                    class="chip chip-outline"
                  >
                    Variantes: {{ product.variants!.length }}
                  </span>
                </div>
              </div>
            </ng-template>

            <!-- Panel content -->
            <div class="pt-4">
              <!-- Imágenes del producto -->
             <!-- Imágenes del producto -->
<div class="mt-6">
  <h4 class="text-pink-500 font-medium mb-2">
    Imágenes del producto
  </h4>

  <div class="flex gap-4">
    <!-- Renderizar imágenes existentes -->
    <div
      *ngFor="let img of product.imagen_url; let idx = index"
      class="w-28 h-28 rounded-lg border bg-white shadow-sm flex items-center justify-center overflow-hidden relative"
    >
      <img
        [src]="img || 'assets/lomito.jpg'"
        alt="Imagen producto"
        class="w-full h-full object-cover"
      />
      <!--<button
        pButton
        type="button"
        icon="pi pi-times"
        class="absolute top-1 right-1 p-button-rounded p-button-danger p-button-sm"
        (click)="removeImage(product, idx)"
      ></button> -->
    </div>

    <!-- Slots vacíos hasta llegar a 3 -->
    <div
      *ngFor="let i of [].constructor(3 - (product.imagen_url?.length || 0))"
      class="w-28 h-28 rounded-lg border border-dashed border-slate-300 flex items-center justify-center cursor-pointer"
      (click)="uploadImage(product, product.imagen_url.length)"
    >
      <i class="pi pi-camera text-slate-400 text-xl"></i>
    </div>
  </div>
</div>


              <!-- Info producto -->
              <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 mt-4">
                <!-- Columna 1 -->
                <div class="space-y-4">
                  <div class="flex flex-col">
                    <label for="nombre">Nombre</label>
                    <input
                      pInputText
                      type="text"
                      [disabled]="disabledFields"
                      [(value)]="product.nombre_producto"
                    />
                  </div>

                  <div class="flex flex-col">
                    <label for="precio">Precio</label>
                    <input
                      pInputText
                      type="number"
                      [disabled]="disabledFields"
                      [(value)]="product.precio"
                    />
                  </div>

                  <div class="flex flex-col">
                    <label for="codigo">SKU/Código</label>
                    <input
                      pInputText
                      type="text"
                      [disabled]="disabledFields"
                      [(value)]="product.sku"
                    />
                  </div>
                </div>

                <!-- Columna 2 -->
                <div class="space-y-4">
                  <div class="flex flex-col">
                    <label for="categoria">Categoría</label>
                    <input
                      pInputText
                      type="text"
                      [disabled]="true"
                      [value]="product.category?.name || 'Sin categoría'"
                    />
                  </div>

                  <div class="flex flex-col">
                    <label for="grupo">Grupo</label>
                    <input
                      pInputText
                      type="text"
                      [disabled]="disabledFields"
                      [(value)]="product.grupo"
                    />
                  </div>

                  <div class="flex flex-col">
                    <label for="codigo_barras">Código de barras</label>
                    <input
                      pInputText
                      type="text"
                      [disabled]="disabledFields"
                      [(value)]="product.codigo_barras"
                    />
                  </div>

                  <div class="flex flex-col">
                    <label for="condicion">Condición</label>
                    <input
                      pInputText
                      type="text"
                      [disabled]="disabledFields"
                      [value]="product.condicion"
                    />
                  </div>
                </div>

                <!-- Columna 3 -->
                <div class="space-y-4">
                  <div class="flex flex-col">
                    <label for="stock">Stock total</label>
                    <input
                      pInputText
                      type="number"
                      [disabled]="true"
                      [value]="getTotalStock(product)"
                    />
                  </div>

                  <div class="flex flex-col">
                    <label for="unidad_medida">Unidad de medida</label>
                    <input
                      pInputText
                      type="text"
                      [disabled]="disabledFields"
                      [value]="product.unidad_medida"
                    />
                  </div>

                  <div class="flex flex-col">
                    <label for="vencimiento">Vencimiento</label>
                    <input
                      pInputText
                      type="date"
                      [disabled]="disabledFields"
                      [value]="
                        product.vencimiento
                          ? (product.vencimiento | date : 'yyyy-MM-dd')
                          : ''
                      "
                    />
                  </div>

                  <div class="flex flex-col">
                    <label for="descripcion">Descripción</label>
                    <textarea
                      pInputTextarea
                      label="Descripción"
                      placeholder="Escribe una descripción..."
                      [value]="product.descripcion"
                      [disabled]="disabledFields"
                    ></textarea>
                  </div>
                </div>
              </div>

              <!-- Variantes -->
              <!-- Variantes -->
              <div
                *ngIf="
                  product.presentacion_multiple && product.variants?.length
                "
                class="mt-6"
              >
                <h4 class="text-pink-500 font-medium mb-2">Variantes</h4>

                <div
                  class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4"
                >
                  <div
                    *ngFor="let v of product.variants; trackBy: trackByVariant"
                    class="rounded-xl border border-slate-200 bg-white p-4 shadow-sm"
                  >
                    <div class="grid grid-cols-1 gap-3">
                      <!-- Nombre variante -->
                      <div class="flex flex-col gap-1">
                        <label class="text-sm font-medium text-slate-700"
                          >Nombre variante</label
                        >
                        <input
                          pInputText
                          type="text"
                          [(ngModel)]="v.nombre"
                          [disabled]="disabledFields"
                          class="w-full"
                        />
                      </div>

                      <!-- Stock -->
                      <div class="flex flex-col gap-1">
                        <label class="text-sm font-medium text-slate-700"
                          >Stock</label
                        >
                        <p-inputNumber
                          [(ngModel)]="v.stock"
                          [disabled]="disabledFields"
                          inputId="stock-{{ v.id_variant }}"
                          mode="decimal"
                          [min]="0"
                          class="w-full"
                        ></p-inputNumber>
                      </div>

                      <!-- Precio -->
                      <div class="flex flex-col gap-1">
                        <label class="text-sm font-medium text-slate-700"
                          >Precio</label
                        >
                        <p-inputNumber
                          [(ngModel)]="v.precio"
                          [disabled]="disabledFields"
                          inputId="precio-{{ v.id_variant }}"
                          mode="currency"
                          currency="ARS"
                          locale="es-AR"
                          class="w-full"
                        ></p-inputNumber>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Acciones -->
              <div class="mt-6 flex items-center justify-end gap-2">
                <button
                  pButton
                  label="Editar producto"
                  class="p-button-outlined"
                  (click)="openEditDialog(product)"
                ></button>
              </div>
            </div>
          </p-accordionTab>
        </p-accordion>
      </ng-container>

      <!-- Empty state -->
      <ng-template #emptyTpl>
        <div
          class="bg-white border border-slate-200 rounded-2xl shadow-sm p-10 text-center"
        >
          <div
            class="mx-auto w-14 h-14 rounded-2xl bg-pink-50 flex items-center justify-center text-pink-500 mb-3"
          >
            <i class="pi pi-box text-2xl"></i>
          </div>
          <h3 class="text-lg font-semibold text-slate-800">
            Aún no hay productos
          </h3>
          <p class="text-sm text-slate-500 mt-1">
            Crea tu primer producto para empezar a vender.
          </p>
          <button
            pButton
            label="Agregar producto"
            icon="pi pi-plus"
            class="mt-4 rounded-full bg-emerald-500 hover:bg-emerald-600 text-white px-5 py-2.5 shadow-sm"
            (click)="openCreateDialog()"
          ></button>
        </div>
      </ng-template>
    </ng-template>
  </div>

  <!-- Paginador -->
  <div class="flex justify-center mt-6">
    <p-paginator
      [rows]="pageSize"
      [totalRecords]="totalItems"
      [rowsPerPageOptions]="[5, 10, 20]"
      (onPageChange)="onPageChange($event)"
    ></p-paginator>
  </div>
</div>

<!-- Editar producto -->
<app-product-dialog
  [product]="selectedProduct"
  [storeId]="currentStoreSlug"
  [visible]="editVisible"
  (visibleChange)="editVisible = $event"
></app-product-dialog>

<!-- Crear producto -->
<app-product-dialog
  [storeId]="currentStoreSlug"
  [visible]="createVisible"
  (visibleChange)="createVisible = $event"
></app-product-dialog>
