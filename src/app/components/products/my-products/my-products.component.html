<p-toast></p-toast>
<p-confirmDialog></p-confirmDialog>

<div class="mt-6">
  <!--  Encabezado moderno responsive -->
  <app-page-header
    title="Mis productos"
    subtitle="Gestion谩 tus productos, fotos y variantes desde un solo lugar."
    icon="pi pi-shopping-bag"
  ></app-page-header>

<!--  Toolbar de filtros -->
<div class="px-4 sm:px-12 mb-6 flex flex-wrap gap-3 items-center justify-between">
  <!--  Buscador -->
  <div class="flex items-center gap-2 flex-1 min-w-[220px]">
    <i class="pi pi-search text-slate-400"></i>
    <input
      type="text"
      pInputText
      [formControl]="searchCtrl"
      placeholder="Buscar por nombre, SKU o c贸digo"
      class="flex-1 bg-transparent text-slate-700 placeholder:text-slate-400"
    />
  </div>

  <!--  Bot贸n para mostrar filtros -->
  <button
    pButton
    label="Filtros"
    icon="pi pi-sliders-h"
    class="p-button-outlined p-button-sm rounded-full"
    (click)="showFilters = !showFilters"
  ></button>

  <!--  Bot贸n crear producto -->
  <button
    pButton
    label="Agregar producto"
    icon="pi pi-plus"
    class="rounded-full px-5 py-2.5 font-semibold text-white shadow-md bg-gradient-to-r from-pink-500 to-purple-600 hover:opacity-90 transition"
    (click)="openCreateDialog()"
  ></button>
</div>

<!--  Contenedor de filtros avanzados (toggle) -->
<p-fieldset
  *ngIf="showFilters"
  legend="Filtros avanzados"
  [toggleable]="true"
  [collapsed]="false"
  class="mx-4 sm:mx-12 mb-6 shadow-sm border border-slate-200 rounded-2xl bg-white"
>
  <div class="flex flex-wrap gap-4 items-center">
    <p-dropdown
      [options]="sortOptions"
      placeholder="Ordenar por"
      optionLabel="label"
      optionValue="value"
      (onChange)="onSortChange($event.value)"
      class="w-44"
    ></p-dropdown>

    <p-dropdown
      [options]="conditionOptions"
      placeholder="Condici贸n"
      optionLabel="label"
      optionValue="value"
      (onChange)="onConditionChange($event.value)"
      class="w-40"
    ></p-dropdown>

    <p-dropdown
      [options]="availableOptions"
      placeholder="Disponibilidad"
      optionLabel="label"
      optionValue="value"
      (onChange)="onAvailableChange($event.value)"
      class="w-44"
    ></p-dropdown>

    <p-dropdown
      [options]="unidadOptions"
      placeholder="Unidad"
      optionLabel="label"
      optionValue="value"
      (onChange)="onUnidadChange($event.value)"
      class="w-40"
    ></p-dropdown>

    <div class="flex items-center gap-2">
      <input
        type="number"
        pInputText
        placeholder="Min $"
        class="w-24"
        #minPrice
      />
      <input
        type="number"
        pInputText
        placeholder="Max $"
        class="w-24"
        #maxPrice
      />
      <button
        pButton
        icon="pi pi-filter"
        class="p-button-outlined p-button-sm"
        (click)="onPriceChange(minPrice.value, maxPrice.value)"
      ></button>
    </div>

    <!-- Ъ Bot贸n limpiar filtros -->
    <button
      pButton
      label="Limpiar filtros"
      icon="pi pi-times"
      class="p-button-text p-button-sm text-slate-500"
      (click)="clearFilters()"
    ></button>
  </div>
</p-fieldset>



  <!--  Contenido principal -->
  <div class="px-4 sm:px-12">
    <!-- Skeleton mientras carga -->
    <ng-container *ngIf="isLoading; else contentTpl">
      <div class="bg-white border border-slate-200 rounded-2xl shadow-sm p-6">
        <p-skeleton width="40%" height="1.5rem" class="mb-4"></p-skeleton>
        <p-skeleton height="3rem" class="mb-3"></p-skeleton>
        <p-skeleton height="3rem" class="mb-3"></p-skeleton>
        <p-skeleton height="3rem"></p-skeleton>
      </div>
    </ng-container>

    <!--  Lista de productos -->
    <ng-template #contentTpl>
      <ng-container *ngIf="products$ | async as result; else emptyTpl">
        <ng-container *ngIf="result?.data?.length; else emptyTpl">
          <p-accordion [multiple]="true" class="modern-accordion">
            <p-accordionTab
              *ngFor="let product of result.data; trackBy: trackByProduct"
            >
              <ng-template pTemplate="header">
                <div class="flex items-center w-full">
                  <div
                    class="w-12 h-12 rounded-xl overflow-hidden ring-1 ring-slate-200 bg-white mr-3"
                  >
                    <img
                      class="w-full h-full object-cover"
                      [src]="product.imagen_url[0] || 'assets/placeholder.png'"
                      alt="{{ product.nombre_producto }}"
                    />
                  </div>
                  <div class="min-w-0 flex-1">
                    <div class="font-medium text-slate-800 truncate">
                      {{ product.nombre_producto }}
                    </div>
                    <div class="text-xs text-slate-500 truncate">
                      {{ product.category?.name || "Sin categor铆a" }}
                    </div>
                  </div>

                  <div class="flex items-center gap-2 ml-auto">
                    <span class="chip chip-soft">
                      <span class="chip-dot bg-emerald-500"></span>
                      Stock: {{ getTotalStock(product) }}
                    </span>
                    <span class="chip chip-soft">
                      <span class="chip-dot bg-indigo-500"></span>
                      {{
                        product.presentacion_multiple &&
                        product.variants?.length
                          ? "Desde " +
                            (getMinPrice(product)
                              | currency : "ARS" : "symbol-narrow" : "1.0-0")
                          : (product.precio
                            | currency : "ARS" : "symbol-narrow" : "1.0-0")
                      }}
                    </span>
                    <span
                      *ngIf="
                        product.presentacion_multiple &&
                        product.variants?.length
                      "
                      class="chip chip-outline"
                    >
                      Variantes: {{ product.variants?.length || 0 }}
                    </span>
                  </div>
                </div>
              </ng-template>

              <!--  Detalles del producto -->
              <div class="pt-4">
                <div class="mt-6">
                  <h4 class="text-pink-500 font-medium mb-2">
                    Im谩genes del producto
                  </h4>
                  <div class="flex gap-4">
                    <div
                      *ngFor="let img of product.imagen_url; let idx = index"
                      class="w-48 h-48 rounded-lg border bg-white shadow-sm flex items-center justify-center overflow-hidden relative"
                    >
                      <img
                        [src]="img || 'assets/lomito.jpg'"
                        alt="Imagen producto"
                        class="w-full h-full object-cover"
                      />
                    </div>

                    <!-- Slots vac铆os hasta llegar a 3 -->
                    <div
                      *ngFor="
                        let i of [].constructor(
                          3 - (product.imagen_url?.length || 0)
                        )
                      "
                      class="w-48 h-48 rounded-lg border border-dashed border-slate-300 flex items-center justify-center cursor-pointer"
                      (click)="uploadImage(product, product.imagen_url.length)"
                    >
                      <i class="pi pi-camera text-slate-400 text-xl"></i>
                    </div>
                  </div>
                </div>

                <!-- Info producto -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 mt-4">
                  <!-- Columna 1 -->
                  <div class="space-y-4">
                    <div class="flex flex-col">
                      <label for="nombre">Nombre</label>
                      <input
                        pInputText
                        type="text"
                        [disabled]="disabledFields"
                        [(value)]="product.nombre_producto"
                      />
                    </div>

                    <div class="flex flex-col">
                      <label for="precio">Precio</label>
                      <input
                        pInputText
                        type="number"
                        [disabled]="disabledFields"
                        [(value)]="product.precio"
                      />
                    </div>

                    <div class="flex flex-col">
                      <label for="codigo">SKU/C贸digo</label>
                      <input
                        pInputText
                        type="text"
                        [disabled]="disabledFields"
                        [(value)]="product.sku"
                      />
                    </div>
                  </div>

                  <!-- Columna 2 -->
                  <div class="space-y-4">
                    <div class="flex flex-col">
                      <label for="categoria">Categor铆a</label>
                      <input
                        pInputText
                        type="text"
                        [disabled]="true"
                        [value]="product.category?.name || 'Sin categor铆a'"
                      />
                    </div>

                    <div class="flex flex-col">
                      <label for="grupo">Grupo</label>
                      <input
                        pInputText
                        type="text"
                        [disabled]="disabledFields"
                        [(value)]="product.grupo"
                      />
                    </div>

                    <div class="flex flex-col">
                      <label for="codigo_barras">C贸digo de barras</label>
                      <input
                        pInputText
                        type="text"
                        [disabled]="disabledFields"
                        [(value)]="product.codigo_barras"
                      />
                    </div>

                    <div class="flex flex-col">
                      <label for="condicion">Condici贸n</label>
                      <input
                        pInputText
                        type="text"
                        [disabled]="disabledFields"
                        [value]="product.condicion"
                      />
                    </div>
                  </div>

                  <!-- Columna 3 -->
                  <div class="space-y-4">
                    <div class="flex flex-col">
                      <label for="stock">Stock total</label>
                      <input
                        pInputText
                        type="number"
                        [disabled]="true"
                        [value]="getTotalStock(product)"
                      />
                    </div>

                    <div class="flex flex-col">
                      <label for="unidad_medida">Unidad de medida</label>
                      <input
                        pInputText
                        type="text"
                        [disabled]="disabledFields"
                        [value]="product.unidad_medida"
                      />
                    </div>

                    <div class="flex flex-col">
                      <label for="vencimiento">Vencimiento</label>
                      <input
                        pInputText
                        type="date"
                        [disabled]="disabledFields"
                        [value]="
                          product.vencimiento
                            ? (product.vencimiento | date : 'yyyy-MM-dd')
                            : ''
                        "
                      />
                    </div>

                    <div class="flex flex-col">
                      <label for="descripcion">Descripci贸n</label>
                      <textarea
                        pInputTextarea
                        label="Descripci贸n"
                        placeholder="Escribe una descripci贸n..."
                        [value]="product.descripcion"
                        [disabled]="disabledFields"
                      ></textarea>
                    </div>
                  </div>
                </div>

                <!-- Variantes -->
              </div>

              <div
                *ngIf="
                  product.presentacion_multiple && product.variants?.length
                "
                class="mt-6"
              >
                <h4 class="text-pink-500 font-medium mb-2">Variantes</h4>
                <div
                  class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4"
                >
                  <div
                    *ngFor="let v of product.variants; trackBy: trackByVariant"
                    class="rounded-xl border border-slate-200 bg-white p-4 shadow-sm"
                  >
                    <div class="text-sm font-medium text-slate-800">
                      {{ v.nombre }}
                    </div>
                    <div class="text-xs text-slate-500">
                      Stock: {{ v.stock }} |
                      {{
                        v.precio | currency : "ARS" : "symbol-narrow" : "1.0-0"
                      }}
                    </div>
                  </div>
                </div>
              </div>

              <div class="mt-6 flex items-center justify-end gap-2">
                <p-button
                  label="Eliminar producto"
                  severity="danger"
                  variant="outlined"
                  [rounded]="true"
                  size="small"
                  class="text-xs px-3 h-8"
                  (onClick)="onDeleteProduct(product.id_producto)"
                />
                <p-button
                  [rounded]="true"
                  size="small"
                  label="Editar producto"
                  severity="secondary"
                  class="text-xs px-3 py-1 h-8"
                  (click)="openEditDialog(product)"
                />
              </div>
            </p-accordionTab>
          </p-accordion>
        </ng-container>
      </ng-container>

      <!--  Estado vac铆o -->
      <ng-template #emptyTpl>
        <div
          class="bg-white border border-slate-200 rounded-2xl shadow-lg p-10 text-center backdrop-blur-xl"
        >
          <div
            class="mx-auto w-14 h-14 rounded-2xl bg-pink-50 flex items-center justify-center text-pink-500 mb-3 shadow-sm"
          >
            <i class="pi pi-box text-2xl"></i>
          </div>
          <h3 class="text-lg font-semibold text-slate-800">
            A煤n no hay productos
          </h3>
          <p class="text-sm text-slate-500 mt-1">
            Crea tu primer producto para empezar a vender.
          </p>
          <button
            pButton
            label="Agregar producto"
            icon="pi pi-plus"
            class="mt-4 rounded-full bg-gradient-to-r from-pink-500 to-purple-600 text-white px-5 py-2.5 shadow-sm hover:opacity-90"
            (click)="openCreateDialog()"
          ></button>
        </div>
      </ng-template>
    </ng-template>
  </div>

  <!--  Paginador -->
  <div class="flex justify-center mt-6">
    <p-paginator
      [rows]="pageSize"
      [totalRecords]="totalItems"
      [first]="currentPage * pageSize"
      [rowsPerPageOptions]="[5, 10, 20]"
      (onPageChange)="onPageChange($event)"
    ></p-paginator>
  </div>
</div>

<!--  Di谩logos -->
<app-product-dialog
  [product]="selectedProduct"
  [storeId]="currentStoreSlug"
  [visible]="editVisible"
  (visibleChange)="editVisible = $event"
></app-product-dialog>

<app-product-dialog
  [storeId]="currentStoreSlug"
  [visible]="createVisible"
  (visibleChange)="createVisible = $event"
></app-product-dialog>
