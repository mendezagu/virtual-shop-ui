<form [formGroup]="productForm" (ngSubmit)="crearProducto()" class="flex flex-col gap-4">
  <mat-form-field appearance="fill">
    <mat-label>Nombre producto</mat-label>
    <input matInput formControlName="nombre_producto" />
    @if (productForm.get('nombre_producto')?.touched && productForm.get('nombre_producto')?.invalid) {
      <mat-error>Nombre producto es obligatorio</mat-error>
    }
  </mat-form-field>

  <!-- Select de categorías -->
  <mat-form-field appearance="fill">
    <mat-label>Categoría</mat-label>
    <mat-select formControlName="categoriaSelect" (selectionChange)="onCategorySelectChange($event.value)">
      <mat-option *ngFor="let c of categories" [value]="c.name">
        {{ c.name }} <span class="text-slate-400">({{ c.count }})</span>
      </mat-option>
      <mat-option value="__NEW__">+ Crear nueva categoría</mat-option>
    </mat-select>
    @if (productForm.get('categoria')?.touched && productForm.get('categoria')?.invalid) {
      <mat-error>Selecciona una categoría o crea una nueva</mat-error>
    }
  </mat-form-field>

  <!-- Input visible solo si elige crear nueva -->
  <mat-form-field appearance="fill" *ngIf="showNewCategory">
    <mat-label>Nueva categoría</mat-label>
    <input matInput formControlName="categoria" placeholder="Ej. Panadería artesanal" />
    @if (productForm.get('categoria')?.touched && productForm.get('categoria')?.invalid) {
      <mat-error>La categoría es obligatoria</mat-error>
    }
  </mat-form-field>

  <mat-form-field appearance="fill">
    <mat-label>Grupo</mat-label>
    <input matInput formControlName="grupo" />
  </mat-form-field>

  <mat-form-field appearance="fill">
    <mat-label>Descripción</mat-label>
    <textarea matInput formControlName="descripcion"></textarea>
  </mat-form-field>

  <mat-form-field appearance="fill">
    <mat-label>Stock</mat-label>
    <input matInput type="number" formControlName="stock" />
  </mat-form-field>

  <mat-form-field appearance="fill">
    <mat-label>Precio</mat-label>
    <input matInput type="number" formControlName="precio" />
  </mat-form-field>

  <mat-checkbox formControlName="presentacion_multiple">Producto con variantes</mat-checkbox>

  @if (productForm.get('presentacion_multiple')?.value) {
    <div formArrayName="variants">
      @for (varGroup of variants.controls; let i = $index; track i) {
        <div [formGroupName]="i" class="flex gap-2 mb-2">
          <mat-form-field>
            <mat-label>Nombre Variante</mat-label>
            <input matInput formControlName="nombre" />
          </mat-form-field>
          <mat-form-field>
            <mat-label>Stock</mat-label>
            <input matInput type="number" formControlName="stock" />
          </mat-form-field>
          <mat-form-field>
            <mat-label>Precio</mat-label>
            <input matInput type="number" formControlName="precio" />
          </mat-form-field>
          <button mat-button type="button" (click)="quitarVariante(i)">Eliminar</button>
        </div>
      }
      <button mat-raised-button type="button" color="accent" (click)="agregarVariante()">
        Agregar Variante
      </button>
    </div>
  }

  <button mat-raised-button color="primary" type="submit" [disabled]="productForm.invalid">
    Crear Producto
  </button>
</form>
