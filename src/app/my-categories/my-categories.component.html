<div class="mt-6">
  <!-- Encabezado -->
  <div class="px-4 sm:px-12 mb-4">
    <div
      class="inline-flex items-center gap-2 rounded-full border border-pink-200 bg-pink-50 px-3 py-1 text-xs text-pink-700"
    >
      <span class="h-2 w-2 rounded-full bg-pink-500"></span>
      Inventario
    </div>
    <h1 class="mt-2 text-3xl font-semibold tracking-tight text-pink-500">
      Mis categorías
    </h1>
    <p class="text-sm text-slate-500 mt-1">
      Visualiza, crea y administra las categorías de tu tienda.
    </p>
  </div>

  <!-- Crear nueva categoría -->
  <div class="px-4 sm:px-12 mb-6">
    <form
      [formGroup]="newCategoryForm"
      (ngSubmit)="createCategory()"
      class="flex flex-col sm:flex-row items-center gap-3"
    >
      <!-- Nombre -->
      <input
        type="text"
        pInputText
        formControlName="name"
        placeholder="Nueva categoría"
        class="flex-1"
      />

      <!-- Subir imagen -->
      <input
        type="file"
        accept="image/*"
        (change)="onFileSelected($event)"
        class="text-sm"
      />

      <!-- Botón crear -->
      <button
        type="submit"
        pButton
        icon="pi pi-plus"
        class="p-button-rounded p-button-success"
        [disabled]="newCategoryForm.invalid"
      ></button>
    </form>
  </div>

  <!-- Contenido -->
  <div class="px-4 sm:px-12">
    <ng-container *ngIf="categories?.length; else emptyTpl">
      <p-accordion
        class="w-full"
        expandIcon="pi pi-plus"
        collapseIcon="pi pi-minus"
      >
        <p-accordionTab
          *ngFor="let c of categories"
          (onOpen)="c.isOpen = true; loadProducts(c)"
          (onClose)="c.isOpen = false"
        >
          <!-- Header -->
          <ng-template pTemplate="header">
            <span class="flex items-center gap-3 w-full">
              <p-avatar
                *ngIf="c.imageUrl; else defaultIcon"
                [image]="c.imageUrl"
                shape="circle"
                styleClass="border border-slate-200"
              ></p-avatar>
              <ng-template #defaultIcon>
                <p-avatar
                  icon="pi pi-folder"
                  shape="circle"
                  styleClass="bg-pink-100 text-pink-500"
                ></p-avatar>
              </ng-template>

              <span
                class="font-medium text-slate-800 block max-w-[120px] truncate sm:max-w-none"
              >
                {{ c.name }}
              </span>
              <p-badge
                [value]="c.count"
                severity="success"
                class="ml-auto mr-2"
              ></p-badge>
            </span>
          </ng-template>

          <!-- === CUERPO DEL TAB CON LA ESTRUCTURA DE LA IMAGEN === -->
          <div class="space-y-4">
            <!-- Categoría principal -->
            <form
              [formGroup]="categoryForms[c.id]"
              (ngSubmit)="updateCategory(c)"
              class="flex items-center gap-2"
            >
              <i class="pi pi-bars text-slate-400"></i>
              <input
                type="text"
                pInputText
                formControlName="name"
                class="flex-1"
              />
              <button
                type="button"
                pButton
                icon="pi pi-plus"
                class="p-button-rounded p-button-success h-10 w-10"
                (click)="
                  subCategoryForms[c.id].valid && createSubCategory(c.id)
                "
              ></button>
              <button
                type="button"
                pButton
                [size]="'small'"
                icon="pi pi-trash"
                class="p-button-rounded p-button-danger h-10 w-10"
                (click)="deleteCategory(c)"
              ></button>
            </form>

            <!-- Subcategorías -->
            <div class="pl-8 mt-3 space-y-2" *ngIf="c.subcategories?.length">
              <div
                *ngFor="let sub of c.subcategories"
                class="flex items-center gap-2"
              >
                <i class="pi pi-angle-right text-slate-400"></i>
                <input
                  type="text"
                  pInputText
                  [value]="sub.name"
                  disabled
                  class="flex-1"
                />
                <button
                  type="button"
                  pButton
                  icon="pi pi-trash"
                  class="p-button-rounded p-button-danger h-10 w-10"
                  (click)="deleteCategory(sub)"
                ></button>
              </div>
            </div>

            <!-- Crear subcategoría -->
            <form
              [formGroup]="subCategoryForms[c.id]"
              (ngSubmit)="createSubCategory(c.id)"
              class="pl-8 mt-3 flex items-center gap-2"
            >
              <i class="pi pi-angle-right text-slate-400"></i>
              <input
                type="text"
                pInputText
                formControlName="name"
                placeholder="Nueva Subcategoría"
                class="flex-1"
              />
              <button
                type="submit"
                pButton
                icon="pi pi-plus"
                class="p-button-rounded p-button-success h-10 w-10"
                [disabled]="subCategoryForms[c.id].invalid"
              ></button>
            </form>
          </div>
        </p-accordionTab>
      </p-accordion>
    </ng-container>

    <!-- Estado vacío -->
    <ng-template #emptyTpl>
      <div
        class="bg-white border border-slate-200 rounded-2xl shadow-sm p-10 text-center"
      >
        <div
          class="mx-auto w-14 h-14 rounded-2xl bg-pink-50 flex items-center justify-center text-pink-500 mb-3"
        >
          <i class="pi pi-tags text-2xl"></i>
        </div>
        <h3 class="text-lg font-semibold text-slate-800">
          Aún no tienes categorías
        </h3>
        <p class="text-sm text-slate-500 mt-1">
          Crea tu primera categoría para organizar tus productos.
        </p>
      </div>
    </ng-template>
  </div>
</div>

<p-toast></p-toast>
<p-confirmDialog></p-confirmDialog>
