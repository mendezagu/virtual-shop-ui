<div class="mt-6 px-4 sm:px-10 lg:px-12 pb-10">
  <!-- 游댳 Encabezado -->
  <app-page-header
    title="Mis categor칤as"
    subtitle="Visualiz치, cre치 y administr치 las categor칤as de tu tienda."
    icon="pi pi-objects-column"
  ></app-page-header>

  <!-- 游댳 Tabs -->
  <p-tabView>
    <!-- TAB NORMAL -->
    <p-tabPanel>
      <ng-template pTemplate="header">
        <i class="pi pi-objects-column"></i>
        <span class="ml-2">Categor칤as</span>
      </ng-template>

      <!-- Bot칩n crear -->
      <div class="flex justify-end mt-6 mb-8">
        <button
          pButton
          label="Nueva categor칤a"
          icon="pi pi-plus"
          class="rounded-full font-semibold px-5 py-2.5 text-white bg-gradient-to-r from-[var(--secondary)] to-[var(--primary)] shadow-md hover:shadow-lg hover:scale-[1.02] transition-transform"
          (click)="openCategoryDialog()"
        ></button>
      </div>

      <!-- 游댲 Listado -->
      <div>
        <ng-container *ngIf="categories?.length; else emptyTpl">
          <p-accordion [multiple]="true" class="space-y-4">
            <p-accordionTab
              *ngFor="let c of categories"
              (onOpen)="c.isOpen = true; loadProducts(c)"
              (onClose)="c.isOpen = false"
              class="rounded-2xl overflow-hidden border border-slate-200 bg-white/80 backdrop-blur-md shadow-sm hover:shadow-md transition-all duration-300"
            >
              <!-- HEADER 칔NICO (sin [header]) -->
              <ng-template pTemplate="header">
                <div class="flex items-center w-full">
                  <!-- Columna fija para icono/avatar (8rem) -->
                  <div class="w-20 shrink-0">
                    <div
                      class="w-10 h-10 rounded-full overflow-hidden ring-1 ring-slate-200 bg-white"
                    >
                      <ng-container *ngIf="c.imageUrl; else folderIcon">
                        <img
                          [src]="c.imageUrl"
                          alt=""
                          class="w-full h-full object-cover"
                        />
                      </ng-container>
                      <ng-template #folderIcon>
                        <div
                          class="w-full h-full flex items-center justify-center bg-[var(--secondary)]/10 text-[var(--secondary)]"
                        >
                          <i class="pi pi-folder text-base"></i>
                        </div>
                      </ng-template>
                    </div>
                  </div>

                  <!-- Nombre -->
                  <span class="font-medium text-slate-700 truncate">
                    {{ c.name }}
                  </span>

                  <!-- Derecha -->
                  <div class="ml-auto flex items-center gap-2">
                    <p-badge [value]="c.count" severity="success"></p-badge>
                    <small class="text-slate-400">Productos</small>
                  </div>
                </div>
              </ng-template>

              <!-- CUERPO -->
              <div class="p-4 space-y-4">
                <!-- Edici칩n -->
                <form
                  [formGroup]="categoryForms[c.id]"
                  (ngSubmit)="updateCategory(c)"
                  class="flex items-center gap-3"
                >
                  <i class="pi pi-bars text-slate-400"></i>
                  <input
                    pInputText
                    formControlName="name"
                    class="flex-1 rounded-xl border-slate-200 focus:border-[var(--secondary)]"
                  />
                  <div class="flex gap-2">
                    <button
                      type="button"
                      pButton
                      icon="pi pi-trash"
                      class="p-button-rounded p-button-danger h-10 w-10"
                      (click)="deleteCategory(c)"
                    ></button>
                  </div>
                </form>

                <!-- Subcategor칤as -->
                <div *ngIf="c.subcategories?.length" class="pl-8 space-y-2">
                  <div
                    *ngFor="let sub of c.subcategories"
                    class="flex items-center gap-3"
                  >
                    <i class="pi pi-angle-right text-slate-400"></i>
                    <input
                      type="text"
                      pInputText
                      [value]="sub.name"
                      disabled
                      class="flex-1 rounded-xl border-slate-200"
                    />
                    <button
                      type="button"
                      pButton
                      icon="pi pi-trash"
                      class="p-button-rounded p-button-danger h-9 w-9"
                      (click)="deleteCategory(sub)"
                    ></button>
                  </div>
                </div>

                <!-- Nueva subcategor칤a -->
                <form
                  [formGroup]="subCategoryForms[c.id]"
                  (ngSubmit)="createSubCategory(c.id)"
                  class="pl-8 flex items-center gap-3"
                >
                  <i class="pi pi-angle-right text-slate-400"></i>
                  <input
                    pInputText
                    formControlName="name"
                    placeholder="Nueva Subcategor칤a"
                    class="flex-1 rounded-xl border-slate-200 focus:border-[var(--secondary)]"
                  />
                  <button
                    type="submit"
                    pButton
                    icon="pi pi-plus"
                    class="p-button-rounded p-button-success h-9 w-9"
                    [disabled]="subCategoryForms[c.id].invalid"
                  ></button>
                </form>
              </div>
            </p-accordionTab>
          </p-accordion>
        </ng-container>

        <!-- Estado vac칤o -->
        <ng-template #emptyTpl>
          <div
            class="text-center rounded-3xl border border-slate-200 bg-white/80 backdrop-blur-md p-12 shadow-sm hover:shadow-md transition"
          >
            <div
              class="mx-auto w-16 h-16 rounded-2xl bg-[var(--secondary)]/10 text-[var(--secondary)] flex items-center justify-center mb-4"
            >
              <i class="pi pi-tags text-3xl"></i>
            </div>
            <h3 class="text-lg font-semibold text-slate-800">
              A칰n no tienes categor칤as
            </h3>
            <p class="text-slate-500 text-sm mt-1">
              Cre치 tu primera categor칤a para organizar tus productos.
            </p>
          </div>
        </ng-template>
      </div>
    </p-tabPanel>

    <!-- TAB ESPECIALES -->
    <p-tabPanel>
      <ng-template pTemplate="header">
        <i class="pi pi-star"></i>
        <span class="ml-2">Categor칤as especiales</span>
      </ng-template>

      <div class="flex justify-end mt-6 mb-8">
        <button
          pButton
          label="Nueva categor칤a especial"
          icon="pi pi-plus"
          class="rounded-full font-semibold px-5 py-2.5 text-white bg-gradient-to-r from-[var(--secondary)] to-[var(--primary)] shadow-md hover:shadow-lg hover:scale-[1.02] transition-transform"
          (click)="openSpecialDialog()"
        ></button>
      </div>

      <div>
        <ng-container *ngIf="specialCategories?.length; else emptySpecialTpl">
          <p-accordion [multiple]="true" class="space-y-4">
            <p-accordionTab
              *ngFor="let sc of specialCategories"
              class="rounded-2xl overflow-hidden border border-slate-200 bg-white/80 backdrop-blur-md shadow-sm hover:shadow-md transition-all duration-300"
            >
              <ng-template pTemplate="header">
                <div class="flex items-center gap-3 w-full">
                  <p-avatar
                    icon="pi pi-star"
                    shape="circle"
                    styleClass="bg-yellow-100 text-yellow-600"
                  ></p-avatar>
                  <span class="font-medium text-slate-700">{{ sc.name }}</span>
                  <p-chip
                    [label]="sc.type"
                    class="ml-auto text-xs font-semibold px-3 py-1 rounded-full bg-[var(--secondary)]/10 text-[var(--secondary)]"
                  ></p-chip>
                </div>
              </ng-template>

              <div class="p-4 space-y-4">
                <form
                  [formGroup]="categoryForms[sc.id]"
                  (ngSubmit)="updateCategory(sc)"
                  class="flex items-center gap-3"
                >
                  <i class="pi pi-bars text-slate-400"></i>
                  <input
                    pInputText
                    formControlName="name"
                    class="flex-1 rounded-xl border-slate-200 focus:border-[var(--secondary)]"
                  />
                  <button
                    type="button"
                    pButton
                    icon="pi pi-trash"
                    class="p-button-rounded p-button-danger h-10 w-10"
                    (click)="deleteCategory(sc)"
                  ></button>
                </form>
              </div>
            </p-accordionTab>
          </p-accordion>
        </ng-container>

        <ng-template #emptySpecialTpl>
          <div
            class="text-center rounded-3xl border border-slate-200 bg-white/80 backdrop-blur-md p-12 shadow-sm hover:shadow-md transition"
          >
            <div
              class="mx-auto w-16 h-16 rounded-2xl bg-yellow-50 text-yellow-600 flex items-center justify-center mb-4"
            >
              <i class="pi pi-star text-3xl"></i>
            </div>
            <h3 class="text-lg font-semibold text-slate-800">
              A칰n no tienes categor칤as especiales
            </h3>
            <p class="text-slate-500 text-sm mt-1">
              Aqu칤 podr치s crear promociones, ofertas o productos destacados.
            </p>
          </div>
        </ng-template>
      </div>
    </p-tabPanel>
  </p-tabView>
</div>

<!-- 游댳 Dialogos -->
<p-dialog
  header="Nueva categor칤a"
  [(visible)]="showCategoryDialog"
  [modal]="true"
  class="rounded-2xl overflow-hidden"
>
  <form
    [formGroup]="newCategoryForm"
    (ngSubmit)="createCategory()"
    class="flex flex-col gap-4"
  >
    <input
      pInputText
      formControlName="name"
      placeholder="Nombre de la categor칤a"
      class="rounded-xl border-slate-200 focus:border-[var(--secondary)]"
    />

    <p-fileUpload
      name="imagen"
      mode="basic"
      chooseLabel="Subir imagen"
      chooseIcon="pi pi-upload"
      accept="image/*"
      maxFileSize="2000000"
      (onSelect)="onFileSelected($event)"
      [auto]="false"
      [customUpload]="true"
    ></p-fileUpload>

    <div class="flex justify-end gap-3 mt-4">
      <button
        pButton
        type="button"
        label="Cancelar"
        class="p-button-text"
        (click)="showCategoryDialog = false"
      ></button>
      <button
        pButton
        type="submit"
        label="Crear"
        icon="pi pi-check"
        [disabled]="newCategoryForm.invalid"
        class="bg-gradient-to-r from-[var(--secondary)] to-[var(--primary)] text-white rounded-full px-5 py-2.5 shadow-md hover:scale-[1.02] transition-transform"
      ></button>
    </div>
  </form>
</p-dialog>

<p-dialog
  header="Nueva categor칤a especial"
  [(visible)]="showSpecialDialog"
  [modal]="true"
  class="rounded-2xl overflow-hidden"
>
  <form
    [formGroup]="newSpecialCategoryForm"
    (ngSubmit)="createSpecialCategory()"
    class="flex flex-col gap-4"
  >
    <input
      pInputText
      formControlName="name"
      placeholder="Nombre de la categor칤a especial"
      class="rounded-xl border-slate-200 focus:border-[var(--secondary)]"
    />

    <p-dropdown
      [options]="specialTypes"
      formControlName="type"
      placeholder="Tipo de categor칤a"
      optionLabel="label"
      optionValue="value"
      class="w-full"
    ></p-dropdown>

    <p-fileUpload
      name="imagen"
      mode="basic"
      chooseLabel="Subir imagen"
      chooseIcon="pi pi-upload"
      accept="image/*"
      maxFileSize="2000000"
      (onSelect)="onSpecialFileSelected($event)"
      [auto]="false"
      [customUpload]="true"
    ></p-fileUpload>

    <div class="flex justify-end gap-3 mt-4">
      <button
        pButton
        type="button"
        label="Cancelar"
        class="p-button-text"
        (click)="showSpecialDialog = false"
      ></button>
      <button
        pButton
        type="submit"
        label="Crear"
        icon="pi pi-check"
        [disabled]="newSpecialCategoryForm.invalid"
        class="bg-gradient-to-r from-[var(--secondary)] to-[var(--primary)] text-white rounded-full px-5 py-2.5 shadow-md hover:scale-[1.02] transition-transform"
      ></button>
    </div>
  </form>
</p-dialog>

<p-toast></p-toast>
<p-confirmDialog></p-confirmDialog>
